{
	email caddy@xn--sb-lka.org
	experimental_http3
	order prometheus first
}

# xcaddy build \
#   --with github.com/abiosoft/caddy-exec \
#   --with github.com/hairyhenderson/caddyprom

(sec_headers) {
	tls {
		on_demand
	}
	header {
		-Server
		Expect-CT report-uri="https://o393671.ingest.sentry.io/api/5363045/security/?sentry_key=9b4ca50af1d6463c86e551c9ca00c110"
		Content-Security-Policy-Report-Only "default-src 'self'; connect-src 'none'; object-src 'none'; script-src 'unsafe-inline' 'self' cdn.bokeh.org cdnjs.cloudflare.com; img-src 'self' data:; style-src 'unsafe-inline' 'self' use.fontawesome.com fonts.googleapis.com *.bootstrapcdn.com cdnjs.cloudflare.com latex.now.sh; font-src use.fontawesome.com fonts.googleapis.com fonts.gstatic.com latex.now.sh; report-uri https://o393671.ingest.sentry.io/api/5363045/security/?sentry_key=9b4ca50af1d6463c86e551c9ca00c110"
		Strict-Transport-Security max-age=543210;
		X-Content-Type-Options nosniff
		X-Frame-Options DENY
		X-Powered-By "Hamster in a wheel"
		Referrer-Policy no-referrer-when-downgrade
		Tk N
	}
	encode zstd gzip
	log {
		output file /var/log/caddy/access.log
	}
}

# so3borgdb6if7zhyano3qo4k46wuqnb2la3336h2lmlxdmgsz5jg6kad.onion:80/test {
# 	redir http://127.0.0.1:1337/
# }

# TODO: How to make sure we dont leak?
so3borgdb6if7zhyano3qo4k46wuqnb2la3336h2lmlxdmgsz5jg6kad.onion:80 {
	#remote_ip 127.0.0.1
	file_server /* {
		root /var/lib/caddy/www/xn--sb-lka.org/
	}
}

www.xn--sb-lka.org {
	redir https://xn--sb-lka.org{uri}
}

xn--sb-lka.org {
	import sec_headers
	prometheus
	header /.well-known/matrix/* Access-Control-Allow-Origin "*"
	reverse_proxy /_synapse/* localhost:8008
	reverse_proxy /_matrix/* localhost:18448 {
		header_down Access-Control-Allow-Origin "https://develop.element.io"  # Only 1 domain allowed :/
		#header_up Host {http.reverse_proxy.upstream.hostport}
	}
	file_server /smittestop/* {
		root /var/lib/caddy/www/xn--sb-lka.org/
		browse #/var/lib/caddy/www/xn--sb-lka.org/smittestop/browse/browse.tpl
	}
	templates /smittestop/
	templates /smittestop/index.html
	file_server /* {
		root /var/lib/caddy/www/xn--sb-lka.org/
	}
}

sm.xn--sb-lka.org {
	import sec_headers
	file_server /* {
		root /var/lib/caddy/www/sm.xn--sb-lka.org/
	}
}

badger.xn--sb-lka.org {
	import sec_headers
	header {
		Clear-Site-Data "*"
	}
	file_server /* {
		root /var/lib/caddy/www/badger.xn--sb-lka.org/
	}
}

mta-sts.xn--sb-lka.org {
	import sec_headers
	file_server /* {
		root /var/lib/caddy/www/mta-sts.xn--sb-lka.org/
	}
}

tor.xn--sb-lka.org {
	import sec_headers
	file_server /* {
		root /var/lib/caddy/www/tor.xn--sb-lka.org/
	}
}

grafana.xn--sb-lka.org {
	import sec_headers

	basicauth /* {
		# systemctl edit caddy
		{$CADDY_USERNAME} {$CADDY_PASSWORD}
	}

	reverse_proxy localhost:3000 {
		header_up -Authorization
	}
}
